import React from "react";
import { Link } from "react-router-dom";
import { CardBody, CardFooter } from "reactstrap";
import PropTypes from "prop-types";

import AuthForm from "../AuthForm/AuthForm";

import fetcher from "fetcher";

import alertTypes from "components/GlobalAlert/alert-types.json";
import params from "./params-login.json";

const propTypes = {
    match:    PropTypes.object,
    location: PropTypes.object,
    history:  PropTypes.object,

    onAlert: PropTypes.func.isRequired
};

class LogIn extends React.Component { 
    
    // Keeps error messages
    state = {
        email: "",
        pass:  ""
    }

    onSubmit = data => {
        this.setState({ email: "", pass: "" });

        return fetcher.post({ url: "/login", data })
            .then( resp => {
                if (resp.status == 404) {
                    return resp.json();
                }
                
                if (!resp.ok) {
                    throw new Error("A problem occured while trying to log you in. " +
                                    "Sorry for this, try again later, please");
                }

                return resp.json();
            })
            .then( json => {
                const error = json.error;

                if (error) {
                    this.setState({ [error.cause]: error.msg });
                } else {
                    console.log(json);
                    // TODO: save jwt to localStorage
                    // TODO: call auth function of App component 
                }
            })
            .catch( err => {
                this.props.onAlert({ type: alertTypes.DANGER, msg: err.message });
            });
    }

    render() {
        return (
            <React.Fragment>
                <CardBody>
                    <AuthForm 
                        params={params}
                        btnLabel="Log In"
                        onSubmit={this.onSubmit}
                        errors={this.state}
                    />
                </CardBody>

                <CardFooter>
                    Do not have an account?
                    <Link to={"/a/signup"}> Sign up</Link>
                </CardFooter>
            </React.Fragment>
        );
    }
}

LogIn.propTypes = propTypes;

export default LogIn;